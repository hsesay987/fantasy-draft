// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String?
  name          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  googleId      String?  @unique
  emailVerified Boolean  @default(false)
  isAdmin       Boolean  @default(false)

  // ðŸ”‘ monetization
  subscriptionTier String? // null | "founder" | "monthly" | "yearly"
  subscriptionEnds DateTime?
  isFounder        Boolean  @default(false)

  // relationships
  drafts              Draft[]
  rooms               Room[]               @relation("RoomHost")
  roomMembers         RoomParticipant[]
  gameResults         GameResult[]
  verificationTokens  VerificationToken[]
  passwordResetTokens PasswordResetToken[]
}

model VerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model GameResult {
  id        String   @id @default(cuid())
  gameId    String
  userId    String
  score     Float
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  game Game @relation(fields: [gameId], references: [id])

  @@index([gameId])
  @@index([userId])
}

model Game {
  id          String       @id @default(cuid())
  type        String // "DRAFT" | "IMPOSTER" | "QUIZ" | "AUX" | "LINEUP"
  category    String // "SPORTS" | "FOOD" | "ANIME" | "TV" | "MUSIC"
  subtype     String? // "NBA" | "NFL" | "ANIME" | "FOOD"
  title       String?
  createdAt   DateTime     @default(now())
  drafts      Draft[]
  gameResults GameResult[]
}

model Room {
  id       String  @id @default(cuid())
  code     String  @unique
  name     String?
  isPublic Boolean @default(false)
  status   String  @default("lobby") // "lobby" | "in_progress" | "completed"

  hostId String
  host   User   @relation("RoomHost", fields: [hostId], references: [id])

  gameType String // "DRAFT" | "IMPOSTER" | ...
  gameId   String? // tie to Game or Draft (depending on how you want)

  createdAt DateTime @default(now())

  participants RoomParticipant[]
}

model RoomParticipant {
  id        String   @id @default(cuid())
  roomId    String
  userId    String
  isHost    Boolean  @default(false)
  createdAt DateTime @default(now())

  room Room @relation(fields: [roomId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([roomId, userId])
}

model NBAPlayer {
  id                String  @id @default(cuid())
  name              String
  firstName         String
  lastName          String
  position          String // Primary position: "PG" | "SG" | "SF" | "PF" | "C" | "UNK"
  eligiblePositions String? // All positions player is eligible for (e.g., "PG,SG")
  imageUrl          String?
  heightInches      Int?
  primaryTeam       String?
  primaryEraFrom    Int?
  primaryEraTo      Int?
  isHallOfFamer     Boolean @default(false)
  totalTeams        Int     @default(1)

  seasonStats NBAPlayerSeasonStat[]
  draftPicks  NBADraftPick[]
}

model NBAPlayerSeasonStat {
  id       String  @id @default(cuid())
  playerId String
  season   Int // season START year (ex: 2025 = 2025â€“26)
  team     String
  pos      String?

  games   Int?
  minutes Float?

  ppg Float
  apg Float
  rpg Float
  spg Float?
  bpg Float?

  tsPct     Float?
  threeRate Float?
  usgPct    Float?

  per     Float?
  ws      Float?
  wsPer48 Float?
  bpm     Float?
  obpm    Float?
  dbpm    Float?
  vorp    Float?

  plusMinusPer100    Float?
  netPlusMinusPer100 Float?

  ptsPer36 Float?
  trbPer36 Float?
  astPer36 Float?
  stlPer36 Float?
  blkPer36 Float?

  allStar    Boolean @default(false)
  allNBA     Int? // 1,2,3
  allDefense Int?
  allRookie  Boolean @default(false)
  mvpShare   Float?
  dpoyShare  Float?

  player NBAPlayer @relation(fields: [playerId], references: [id])

  @@unique([playerId, season])
  @@index([season])
}

model Draft {
  id        String   @id @default(cuid())
  gameId    String
  title     String?
  league    String // "NBA"
  mode      String // "standard" | "free"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  randomEra      Boolean @default(true)
  eraFrom        Int?
  eraTo          Int?
  randomTeam     Boolean @default(true)
  teamConstraint String?

  maxPlayers       Int     @default(5)
  requirePositions Boolean @default(true)

  scoringMethod  String @default("system")
  rules          Json // { maxPpgCap, overallCap, hallRule, multiTeamOnly, playedWithPlayerId, peakMode }
  participants   Int    @default(1)
  playersPerTeam Int    @default(6)

  ownerId String? // nullable for anonymous/offline games
  owner   User?   @relation(fields: [ownerId], references: [id])

  picks NBADraftPick[]
  votes Vote[]

  game Game @relation(fields: [gameId], references: [id])
}

model NBADraftPick {
  id       String @id @default(cuid())
  draftId  String
  playerId String
  slot     Int
  position String

  draft      Draft     @relation(fields: [draftId], references: [id])
  player     NBAPlayer @relation(fields: [playerId], references: [id])
  ownerIndex Int       @default(1)
  seasonUsed Int?
  teamUsed   String?

  @@unique([draftId, slot])
  @@index([draftId, ownerIndex])
  @@index([draftId, slot])
}

model Vote {
  id        String   @id @default(cuid())
  draftId   String
  createdAt DateTime @default(now())
  value     Int // +1, -1 (or 1 only)
  draft     Draft    @relation(fields: [draftId], references: [id])

  @@index([draftId])
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String?
  type      String   // "feedback" | "bug"
  category  String?
  message   String
  url       String?
  userAgent String?
  createdAt DateTime @default(now())
}

